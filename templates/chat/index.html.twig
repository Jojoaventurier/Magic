{% extends 'base.html.twig' %}

{% block title %}Modifier Commentaire{% endblock %}

{% block body %}

<h2>Select a user to chat with</h2>

<ul>
    {% for user in users %}
        <li>
            <a href="{{ path('start_conversation', { 'userId': user.id }) }}">
                {{ user.username }}
            </a>
        </li>
    {% endfor %}
</ul>

<div id="chat-box">
    {% for message in messages %}
        <div class="message">
            <strong>{{ message.author.username }}:</strong> {{ message.content }}
        </div>
    {% endfor %}
</div>

{{ form_start(form) }}
    {{ form_widget(form.content) }}
    <button type="submit">Send</button>
{{ form_end(form) }}


{% block javascripts %}
<script>
const url = new URL('http://localhost:3000/.well-known/mercure');
url.searchParams.append('topic', 'conversation_{{ conversation.id }}');

const eventSource = new EventSource(url);

eventSource.onmessage = function(event) {
    const data = JSON.parse(event.data);
    const chatBox = document.getElementById('chat-box');
    
    const newMessage = document.createElement('div');
    newMessage.classList.add('message');
    newMessage.innerHTML = `<strong>${data.author}:</strong> ${data.content}`;
    
    chatBox.appendChild(newMessage);
};

</script>
{% endblock %}
{% endblock %}