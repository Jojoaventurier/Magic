{% extends 'base.html.twig' %}

{% block title %}Recherche de Cartes{% endblock %}

{% block body %}

{% if app.user %}
    <a href="{{ path('app_deck_manager', {'id': user.id})}}">MES DECKS</a>
{% endif %}

<main>
    <h1>Recherche de Cartes</h1>


    

    <input type="text" class="search" name="search" id="searchId" placeholder="Chercher une carte...">
    <select class="card" name="cardName" id="cardSelect"></select>
    <button type="button" id="researchStart">Rechercher</button>

    <div id="cardBoard" class="board"></div>
</main>

{% block javascripts %}
<script>
    console.log('This log comes from assets/app.js - welcome to AssetMapper! üéâ');

    document.addEventListener('DOMContentLoaded', function() { // le script se d√©clenche uniquement une fois le DOM charg√©
    
        const searchInput = document.getElementById('searchId'); //on r√©cup√®re l'√©l√©ment qui sert de barre de recherche √† l'utilisateur
        const cardSelect = document.getElementById('cardSelect'); // on r√©cup√®re l'√©l√©ment HTML select
        const researchButton = document.getElementById('researchStart'); // on r√©cup√®re le bouton qui doit d√©clenche la recherche
        const cardBoard = document.getElementById('cardBoard'); // r√©cup√®re la div dans laquelle les images et lien vers le d√©tail des cartes r√©cup√©r√©es seront ins√©r√©es
    
        researchButton.addEventListener('click', function() { // on ajoute une fonction qui se d√©clenche au clic de l'utilisateur sur le bouton qui doit d√©clencher la recherche
            const query = searchInput.value; // on attribue la valeur saisie par l'utilisateur √† une variable query qu'on va utiliser dans la requ√™te envers l'api
    
            //requ√™te √† l'api selon la recherche de l'utilisateur
            // fetch(`https://api.scryfall.com/cards/search?q=name:${query}+lang:fr`) recherche pour une carte en fran√ßais sp√©cifiquement
            fetch(`https://api.scryfall.com/cards/search?q=name:${query}`)
                // Convertit la r√©ponse en format JSON
                .then(response => response.json())
                // Une fois que les donn√©es JSON sont disponibles
                .then(data => {
                 //   console.log(data); V√©rifie le format des donn√©es
    
                    if (data.data && Array.isArray(data.data)) { // on v√©rifiqe qu'on r√©cup√®re bien des donn√©es de l'api, et quelle soit sous forme de tableau
    
                        const myNode = document.getElementById("cardBoard"); // permet de r√©initialiser l'affichage des cartes, si l'utilisateur appuie une nouvelle fois sur le bouton de recherche, les cartes affich√©es pr√©c√©demment sont enlev√©es
                            if (myNode) {
                                while (myNode.firstChild) {// tant que cardBoard a des enfants (les cartes que l'on affiche)
                                    myNode.removeChild(myNode.lastChild); // on enl√®ve le dernier enfant de cardBoard jusqu'√† ce qu'il n'y en ait plus
                                }
                            }
                            
                        cardSelect.innerHTML = ''; // Supprime les entr√©es pr√©c√©dentes
    
                        data.data.forEach(card => {
                            const option = document.createElement('option'); // rajoute une option au select pour chaque carte r√©cup√©r√©e depuis l'API
                            option.value = card.id;
                            option.textContent = card.name;
                            cardSelect.appendChild(option);
    
                            if (card.image_uris && card.image_uris.normal) {
                                let displayCard = new Image(250,350); // cr√©√© un nouvel √©l√©ment <img> d'une taille fixe
                                displayCard.src = `${card.image_uris.normal}`; // j'attribue la source de l'image √† l'url correspondant √† l'image que je souhaite afficher (plusieurs tailles possibles)
                                displayCard.id = `${card.id}` // attribution de l'id scryfall de la carte √† l'id de l'√©l√©ment html image g√©n√©r√©
                                displayCard.classList.add('singleCard'); // on ajoute une classe singleCard si manipulation en css n√©cessaire
        
                                // Cr√©e un √©l√©ment <a> pour envelopper l'image
                                var cardDetailUrl = "{{ path('app_card_detail', {'cardId': 'REPLACE_CARD_ID' })}}"; //on attribue le chemin vers le d√©tail de la carte √† la variable cardDetailUrl
                                let link = document.createElement("a"); // on cr√©√© un √©l√©ment <link> que l'on attribue √† la variable link
                                let url = cardDetailUrl.replace('REPLACE_CARD_ID', card.id);
                                link.href = url; // on attribue le lien vers la carte au href du de l'√©l√©ment HTML cr√©√© pour renvoyer vers le d√©tail de la carte
    
                                link.appendChild(displayCard);//  l'image est ajout√©e au lien cr√©√© pr√©c√©demment
                                cardBoard.appendChild(link) // on ajoute le lien √† la div qui affiche les carte (le l'image est ajout√©e au lien, qui lui m√™me est ajout√© √† la div cardBoard)
                            }
                        });
                    } else {
                        console.error('Erreur: la r√©ponse de l\'API ne contient pas un tableau de cartes dans "data"');
                    }
                })
                .catch(error => console.error('Erreur:', error));
        });
    
    });
</script>
{% endblock %}
{% endblock %}

 


