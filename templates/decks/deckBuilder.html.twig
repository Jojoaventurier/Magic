{% extends 'base.html.twig' %}

{% block title %}Constructeur de deck{% endblock %}

{% block body %}

<h1 class="flex justify-center">Deck Builder</h1>

{% if deck.format.formatName is same as 'Commander' %}
<div class="grid grid-cols-2 gap-4">
{% endif %}

<div class="space-y-2 block max-w-sm p-6 m-6 bg-white border border-gray-200 rounded-lg shadow dark:bg-gray-800 dark:border-gray-700">

    <h1><span class='bold'>{{ deck.deckName }}</span></h2>

    <p class="font-normal text-gray-700 dark:text-gray-400">
        créé le {{ deck.creationDate|date('d.m.Y H:i') }}
    </p>

    {% if deck.updateDate %}
    <p class="font-normal text-gray-700 dark:text-gray-400">
        modifié le {{ deck.updateDate|date('d.m.Y H:i') }}
    </p>
    {% endif %}
    
    <p class="font-normal text-gray-700 dark:text-gray-400">
        <span class="bold">Format</span> : {{ deck.format.formatName}}
    </p> <!--TODO -> lien modifier-->
    <p class="font-normal text-gray-700 dark:text-gray-400">
        <span class="bold">Description du deck :</span><br>
        {% if deck.deckDescription is same as null %}
            Aucune description pour le moment...
            {% else %}
            {{ deck.deckDescription }}
        {% endif %}
    </p>
    <div>
        <div class="inline-flex">
            (<img class="h-4 mt-1 w-auto" src="https://img.icons8.com/material-rounded/24/like--v1.png" alt="like--v1"/>
            {{ deck.likes|length }}) 
        </div>
    </div>
    <a class="red hover:underline" href="{{ path('delete_deck', {'user': deck.user.id, 'deck': deck.id}) }}">Supprimer le deck</a><br>
    <a class="red hover:underline" href="{{ path('delete_all_cards_deck', {'user': deck.user.id, 'deck': deck.id}) }}">Supprimer toutes les cartes du deck</a><br>
</div>

{% if deck.format.formatName is same as 'Commander' %}

<div>
    <h3>Votre Commandant</h3>
    <div id="commandZone">

    </div>
</div>


</div>
{% endif %}


<div class="row space-x-4 p-4">
 
        Rechercher une carte :
        <input type="text" class="search" name="search" id="searchId" placeholder="Cherchez une carte...">
        <select class="card" name="cardName" id="cardSelect"></select>
        <button type="button" id="researchStart">Rechercher</button><br>

        <form id="saveCardForm" method="post" action="{{ path('save_card_deck', {'user': deck.user.id, 'deck': deck.id}) }}">
            <input type="hidden" id="cardIdInput" name="cardId">
            <input type="hidden" id="cardData" name="cardData">
            <button type="submit">Ajouter la carte</button>
        </form>
</div>

<div id="cardBoard" class="board">
    <img id="cardImage">
</div>

{# <div id="displayDeck" class="board"> #}
    
      <!-- Toggle Buttons -->
      <div class="flex justify-end mb-4 mr-4">
        <button id="listViewBtn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-l-lg">List View</button>
        <button id="imageViewBtn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 rounded-r-lg">Image View</button>
    </div>

<div class="light-white p-8">
    {% set card_types = ["Creature", "Sorcery", "Instant", "Enchantment", "Artifact", "Planeswalker", "Land",] %}

    <div id="listView" class="grid-cols-4 gap-4">
        {% for type in card_types %}
            <div id="{{ type|lower }}Cards" class="category-container">
                <h3>{{ type }}</h3>
                <ul class="list-none">
                    {% for element in composition %}
                        {% if type in element.card.data.type_line %}
                            <li>
                                <span>{{ element.quantity }}x </span>{{ element.card.data.name }}
                                <span class="space-x-2">
                                    <a class="hover:underline" href="{{ path('plus_card_deck', {'user': deck.user.id, 'deck': deck.id, 'card': element.card.data.id}) }}">+1</a>
                                    <a class="hover:underline" href="{{ path('minus_card_deck', {'user': deck.user.id, 'deck': deck.id, 'card': element.card.data.id}) }}">-1</a>
                                    <a class="hover:underline" class="red" href="{{ path('delete_card_deck', {'user': deck.user.id, 'deck': deck.id, 'card': element.card.data.id}) }}">Supprimer</a>
                                </span>
                            </li>
                        {% endif %}
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>
    
    <div id="imageView" class="grid-cols-4 gap-4">
        {% for type in card_types %}
            <div id="{{ type|lower }}Cards" class="category-container">
                <h3>{{ type }}</h3>
                <div id="displayDeck" class="board">
                    {% for element in composition %}
                        {% if type in element.card.data.type_line %}
                            <div class="card">
                                {% if element.quantity > 1 %}
                                    <img class="singleCard" src="{{ element.card.data.image_uris.normal }}"><span>X{{ element.quantity}}</span>
                                {% else %}
                                    <img class="singleCard" src="{{ element.card.data.image_uris.normal }}">
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    </div>
</div>
    
{# </div> #}

{% block javascripts %} 

<script> //TODO affichage des decks sous forme de carte
        //TODO ajouter une fonction saveCommander (sauvegarder data en JSON) et affichage de la carte dans la vue
        //TODO ajouter un attribut location dans composition
        //TODO max number of cards

    document.addEventListener('DOMContentLoaded', function() { 

        const searchInput = document.getElementById('searchId'); 
        const cardSelect = document.getElementById('cardSelect'); 
        const researchButton = document.getElementById('researchStart'); 
        const cardBoard = document.getElementById('cardBoard'); 
        const saveCardForm = document.getElementById('saveCardForm');
        const cardIdInput = document.getElementById('cardIdInput');
        const cardData = document.getElementById('cardData');

    
        researchButton.addEventListener('click', function() { 
            const query = searchInput.value; 
    
            fetch(`https://api.scryfall.com/cards/search?q=${query}`) //+type:legendary+type:creature
         
                .then(response => response.json())
                .then(data => {
                 //   console.log(data); Vérifie le format des données
    
                    if (data.data && Array.isArray(data.data)) { 
    
                        cardSelect.innerHTML = ''; // Supprime les entrées précédentes
                        const emptySpace = document.createElement('option');
                        emptySpace.innerHTML = 'Veuillez choisir une carte'
                        cardSelect.appendChild(emptySpace);
    
                        data.data.forEach(card => {
                            
                            const option = document.createElement('option'); // rajoute une option au select pour chaque carte récupérée depuis l'API
                            cardJS = JSON.stringify(card)
                            option.value =  JSON.stringify([card.id, cardJS, card.image_uris.normal])

                            option.textContent = card.name;
                            cardSelect.appendChild(option);
                         

                        });
                    } else {
                        console.error('Erreur: la réponse de l\'API ne contient pas un tableau de cartes dans "data"');
                    }
                })
                .catch(error => console.error('Erreur:', error));
        });

        
        // modification dynamique selon ce que l'utilisateur choisit dans le select
        cardSelect.addEventListener('change', function() {

            let text = cardSelect.options[cardSelect.selectedIndex].textContent;

            const cardValue = JSON.parse(cardSelect.value); // Parse the JSON string back into an array
            const cardId = cardValue[0]; // First element is the card ID
            const cardDataJS = cardValue[1]; // Second element is the card data as JSON
            const imageUrl = cardValue[2];
        
            cardIdInput.value = cardId;
            cardData.value = cardDataJS;

            const myNode = document.getElementById("cardBoard"); // permet de réinitialiser l'affichage des cartes, si l'utilisateur appuie une nouvelle fois sur le bouton de recherche, les cartes affichées précédemment sont enlevées
            if (myNode) {
                while (myNode.firstChild) {// tant que cardBoard a des enfants (les cartes que l'on affiche)
                    myNode.removeChild(myNode.lastChild); // on enlève le dernier enfant de cardBoard jusqu'à ce qu'il n'y en ait plus
                }
            }

            //if (card.image_uris && card.image_uris.normal) {
                let displayCard = new Image(250,350); //création d'un affichage pour prévisualiser le commandant sélectionné dans le select
                displayCard.src = imageUrl; 

                displayCard.name = text ;
                displayCard.classList.add('singleCard'); 
                let cardDetailUrl = "{{ path('app_card_detail', {'cardId': 'REPLACE_CARD_ID' })}}"; 
                let link = document.createElement("a"); 
                let url = cardDetailUrl.replace('REPLACE_CARD_ID', cardValue[0]);

                link.href = url; 

                link.appendChild(displayCard);
                cardBoard.appendChild(link)
            //}
           // console.log(value, text);
        });


        const listViewBtn = document.getElementById('listViewBtn');
        const imageViewBtn = document.getElementById('imageViewBtn');
        const listView = document.getElementById('listView');
        const imageView = document.getElementById('imageView');
    
        // Initial State: Show List View by Default
        listView.classList.add('grid');
        imageView.classList.add('hidden');
    
        listViewBtn.addEventListener('click', function() {
            listView.classList.toggle('hidden', false);
            listView.classList.toggle('grid', true);
            imageView.classList.toggle('board', false);
            imageView.classList.toggle('hidden', true);
        });
    
        imageViewBtn.addEventListener('click', function() {
            imageView.classList.toggle('hidden', false);
            imageView.classList.toggle('board', true);
            listView.classList.toggle('grid', false);
            listView.classList.toggle('hidden', true);
        });
    });

</script>

{% endblock %}
{% endblock %}
